/**
 * OAuth Service Usage Examples
 *
 * This file demonstrates how to use the OAuth service for MCP integration
 * in various scenarios including React components, API routes, and hooks.
 */

import { oauthService } from './oauth.service';

// ============================================================================
// Example 1: React Component - Initiating OAuth Flow
// ============================================================================

/**
 * Example: OAuth Login Button Component
 */
export function OAuthLoginButton({ provider }: { provider: string }) {
  const handleLogin = async () => {
    try {
      // Initiate OAuth flow
      const { authUrl } = await oauthService.initiateOAuth(provider);

      // Redirect to authorization URL
      window.location.href = authUrl;
    } catch (error) {
      console.error('Failed to initiate OAuth:', error);
      alert('Failed to start authentication. Please try again.');
    }
  };

  return (
    <button onClick={handleLogin}>
      Connect {provider}
    </button>
  );
}

// ============================================================================
// Example 2: OAuth Callback Handler (Next.js Page)
// ============================================================================

/**
 * Example: OAuth Callback Page Component
 *
 * This component handles the OAuth callback after user authorization.
 * Typically used in pages/oauth/callback.tsx or app/oauth/callback/page.tsx
 */
export function OAuthCallbackPage() {
  const [status, setStatus] = React.useState<'loading' | 'success' | 'error'>('loading');
  const [error, setError] = React.useState<string | null>(null);

  React.useEffect(() => {
    handleCallback();
  }, []);

  async function handleCallback() {
    try {
      // Extract code and state from URL parameters
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');

      if (!code || !state) {
        throw new Error('Missing authorization code or state');
      }

      // Complete OAuth flow
      const result = await oauthService.completeOAuth(code, state);

      if (result.success) {
        setStatus('success');

        // Redirect to success page
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 2000);
      } else {
        throw new Error(result.error || 'OAuth callback failed');
      }
    } catch (err) {
      setStatus('error');
      setError(err instanceof Error ? err.message : 'Unknown error');
    }
  }

  if (status === 'loading') {
    return <div>Completing authentication...</div>;
  }

  if (status === 'error') {
    return (
      <div>
        <h1>Authentication Failed</h1>
        <p>{error}</p>
        <button onClick={() => window.location.href = '/'}>
          Return to Home
        </button>
      </div>
    );
  }

  return (
    <div>
      <h1>Authentication Successful!</h1>
      <p>Redirecting to dashboard...</p>
    </div>
  );
}

// ============================================================================
// Example 3: Custom React Hook for OAuth Management
// ============================================================================

/**
 * Example: useOAuth Hook
 *
 * Custom hook for managing OAuth state in React components
 */
export function useOAuth(provider: string) {
  const [token, setToken] = React.useState<any>(null);
  const [loading, setLoading] = React.useState(true);
  const [error, setError] = React.useState<string | null>(null);

  // Load token on mount
  React.useEffect(() => {
    loadToken();
  }, [provider]);

  async function loadToken() {
    try {
      setLoading(true);
      const storedToken = await oauthService.getStoredToken(provider);
      setToken(storedToken.accessToken ? storedToken : null);
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load token');
    } finally {
      setLoading(false);
    }
  }

  async function connect() {
    try {
      setLoading(true);
      const { authUrl } = await oauthService.initiateOAuth(provider);
      window.location.href = authUrl;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to connect');
      setLoading(false);
    }
  }

  async function disconnect() {
    try {
      setLoading(true);
      await oauthService.revokeToken(provider);
      setToken(null);
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to disconnect');
    } finally {
      setLoading(false);
    }
  }

  async function refresh() {
    try {
      setLoading(true);
      await oauthService.refreshToken(provider);
      await loadToken();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to refresh token');
      setLoading(false);
    }
  }

  return {
    token,
    loading,
    error,
    isConnected: !!token?.accessToken,
    connect,
    disconnect,
    refresh,
  };
}

// Usage in component:
export function MyComponent() {
  const { token, loading, isConnected, connect, disconnect } = useOAuth('google');

  if (loading) return <div>Loading...</div>;

  return (
    <div>
      {isConnected ? (
        <>
          <p>Connected to Google</p>
          <button onClick={disconnect}>Disconnect</button>
        </>
      ) : (
        <button onClick={connect}>Connect Google</button>
      )}
    </div>
  );
}

// ============================================================================
// Example 4: Server-Side Token Management (API Route)
// ============================================================================

/**
 * Example: API Route for Making Authenticated Requests
 *
 * This shows how to use tokens in API routes to make authenticated requests
 * to external services.
 */
export async function makeAuthenticatedRequest(
  provider: string,
  endpoint: string
) {
  try {
    // Get stored token
    const tokenData = await oauthService.getStoredToken(provider);

    if (!tokenData.accessToken) {
      throw new Error('No access token available. Please authenticate first.');
    }

    // Make request with token
    const response = await fetch(endpoint, {
      headers: {
        'Authorization': `Bearer ${tokenData.accessToken}`,
        'Content-Type': 'application/json',
      },
    });

    if (response.status === 401) {
      // Token expired, try to refresh
      console.log('Token expired, refreshing...');

      await oauthService.refreshToken(provider);

      // Retry request with new token
      const newTokenData = await oauthService.getStoredToken(provider);

      const retryResponse = await fetch(endpoint, {
        headers: {
          'Authorization': `Bearer ${newTokenData.accessToken}`,
          'Content-Type': 'application/json',
        },
      });

      return retryResponse.json();
    }

    return response.json();
  } catch (error) {
    console.error('Authenticated request failed:', error);
    throw error;
  }
}

// ============================================================================
// Example 5: Multi-Provider OAuth Management
// ============================================================================

/**
 * Example: Managing Multiple OAuth Providers
 */
export function OAuthProviderManager() {
  const providers = ['google', 'microsoft', 'github'];
  const [connections, setConnections] = React.useState<Record<string, boolean>>({});

  React.useEffect(() => {
    checkConnections();
  }, []);

  async function checkConnections() {
    const results: Record<string, boolean> = {};

    for (const provider of providers) {
      const token = await oauthService.getStoredToken(provider);
      results[provider] = !!token.accessToken;
    }

    setConnections(results);
  }

  async function connectProvider(provider: string) {
    try {
      const { authUrl } = await oauthService.initiateOAuth(provider);
      window.location.href = authUrl;
    } catch (error) {
      console.error(`Failed to connect ${provider}:`, error);
    }
  }

  async function disconnectProvider(provider: string) {
    try {
      await oauthService.revokeToken(provider);
      setConnections(prev => ({ ...prev, [provider]: false }));
    } catch (error) {
      console.error(`Failed to disconnect ${provider}:`, error);
    }
  }

  return (
    <div>
      <h2>Connected Accounts</h2>
      {providers.map(provider => (
        <div key={provider}>
          <span>{provider}: {connections[provider] ? '✓' : '✗'}</span>
          {connections[provider] ? (
            <button onClick={() => disconnectProvider(provider)}>
              Disconnect
            </button>
          ) : (
            <button onClick={() => connectProvider(provider)}>
              Connect
            </button>
          )}
        </div>
      ))}
    </div>
  );
}

// ============================================================================
// Example 6: Error Handling Patterns
// ============================================================================

/**
 * Example: Comprehensive Error Handling
 */
export async function robustOAuthFlow(provider: string) {
  try {
    // Check if already connected
    const existingToken = await oauthService.getStoredToken(provider);

    if (existingToken.accessToken) {
      // Check if token needs refresh
      const now = Date.now();
      const expiresAt = existingToken.expiresAt || 0;
      const bufferTime = 5 * 60 * 1000; // 5 minutes

      if (now + bufferTime >= expiresAt) {
        console.log('Token expiring soon, refreshing...');

        try {
          await oauthService.refreshToken(provider);
          console.log('Token refreshed successfully');
          return { success: true, action: 'refreshed' };
        } catch (refreshError) {
          console.error('Token refresh failed, re-authenticating...');
          // Fall through to re-authentication
        }
      } else {
        console.log('Valid token found');
        return { success: true, action: 'existing' };
      }
    }

    // No valid token, start new OAuth flow
    console.log('Starting new OAuth flow...');
    const { authUrl } = await oauthService.initiateOAuth(provider);

    return {
      success: true,
      action: 'redirect',
      authUrl,
    };
  } catch (error) {
    console.error('OAuth flow failed:', error);

    if (error instanceof Error) {
      return {
        success: false,
        error: error.message,
        name: error.name,
      };
    }

    return {
      success: false,
      error: 'Unknown error occurred',
    };
  }
}

// ============================================================================
// Example 7: Token Expiry Monitoring
// ============================================================================

/**
 * Example: Monitor Token Expiry and Auto-Refresh
 */
export function useTokenMonitor(provider: string) {
  React.useEffect(() => {
    const interval = setInterval(async () => {
      try {
        const token = await oauthService.getStoredToken(provider);

        if (!token.accessToken || !token.expiresAt) {
          return;
        }

        const now = Date.now();
        const timeUntilExpiry = token.expiresAt - now;
        const bufferTime = 5 * 60 * 1000; // 5 minutes

        if (timeUntilExpiry <= bufferTime) {
          console.log(`Token for ${provider} expiring soon, refreshing...`);
          await oauthService.refreshToken(provider);
          console.log(`Token for ${provider} refreshed`);
        }
      } catch (error) {
        console.error(`Token monitor error for ${provider}:`, error);
      }
    }, 60000); // Check every minute

    return () => clearInterval(interval);
  }, [provider]);
}

// ============================================================================
// Example 8: Batch Operations
// ============================================================================

/**
 * Example: Disconnect All Providers
 */
export async function disconnectAllProviders() {
  const providers = ['google', 'microsoft', 'github'];
  const results = [];

  for (const provider of providers) {
    try {
      await oauthService.revokeToken(provider);
      results.push({ provider, success: true });
    } catch (error) {
      results.push({
        provider,
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }
  }

  return results;
}

/**
 * Example: Check All Connected Providers
 */
export async function getConnectedProviders(): Promise<string[]> {
  const providers = ['google', 'microsoft', 'github'];
  const connected = [];

  for (const provider of providers) {
    const token = await oauthService.getStoredToken(provider);
    if (token.accessToken) {
      connected.push(provider);
    }
  }

  return connected;
}

// ============================================================================
// Example 9: Integration with Zustand Store
// ============================================================================

/**
 * Example: Zustand Store for OAuth State Management
 */
import { create } from 'zustand';

interface OAuthState {
  tokens: Record<string, any>;
  loading: boolean;
  error: string | null;
  connect: (provider: string) => Promise<void>;
  disconnect: (provider: string) => Promise<void>;
  refresh: (provider: string) => Promise<void>;
  loadToken: (provider: string) => Promise<void>;
}

export const useOAuthStore = create<OAuthState>((set, get) => ({
  tokens: {},
  loading: false,
  error: null,

  connect: async (provider: string) => {
    set({ loading: true, error: null });
    try {
      const { authUrl } = await oauthService.initiateOAuth(provider);
      window.location.href = authUrl;
    } catch (error) {
      set({
        loading: false,
        error: error instanceof Error ? error.message : 'Connection failed',
      });
    }
  },

  disconnect: async (provider: string) => {
    set({ loading: true, error: null });
    try {
      await oauthService.revokeToken(provider);
      set(state => ({
        tokens: { ...state.tokens, [provider]: null },
        loading: false,
      }));
    } catch (error) {
      set({
        loading: false,
        error: error instanceof Error ? error.message : 'Disconnection failed',
      });
    }
  },

  refresh: async (provider: string) => {
    set({ loading: true, error: null });
    try {
      await oauthService.refreshToken(provider);
      await get().loadToken(provider);
    } catch (error) {
      set({
        loading: false,
        error: error instanceof Error ? error.message : 'Refresh failed',
      });
    }
  },

  loadToken: async (provider: string) => {
    set({ loading: true, error: null });
    try {
      const token = await oauthService.getStoredToken(provider);
      set(state => ({
        tokens: { ...state.tokens, [provider]: token },
        loading: false,
      }));
    } catch (error) {
      set({
        loading: false,
        error: error instanceof Error ? error.message : 'Failed to load token',
      });
    }
  },
}));

// Usage in component:
export function OAuthStoreExample() {
  const { tokens, loading, connect, disconnect } = useOAuthStore();

  return (
    <div>
      {loading && <p>Loading...</p>}
      {Object.entries(tokens).map(([provider, token]) => (
        <div key={provider}>
          <span>{provider}: {token?.accessToken ? '✓' : '✗'}</span>
          {token?.accessToken ? (
            <button onClick={() => disconnect(provider)}>Disconnect</button>
          ) : (
            <button onClick={() => connect(provider)}>Connect</button>
          )}
        </div>
      ))}
    </div>
  );
}
